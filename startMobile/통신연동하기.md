<!-- Firebase 사용 샘플
ajax 통신
name 세팅하는 방법(코딩, UI)
fmt 파일 생성, mask 설정
AView.setData 호출, 특정데이터를 가공하여 컴포넌트에 setData
 -->

# 통신 연동하기

## 1. Firebase 연동

[Firebase 사이트](https://firebase.google.com/) 에 접속한다. <br/>시작하기 버튼을 눌러 Console 로 이동하고 프로젝트와 웹앱을 추가한다. <br/>
Firebase SDK snippet 내용을 SpiderGen 프로젝트에 추가한다.

### 1.1 Firebase Database 설정

Firebase 에서 데이터를 수신하여 표현하기 위해서 프로젝트에 RealTime Database 사용 설정한다. 데이터는 아래의 내용을 파일로 저장한 뒤 Firebase Database 데이터의 "..." - "JSON 가져오기" 로 업로드하여 적용한다.

```js
{
  "users" : [ {
    "email" : "user1@xxx.com",
    "id" : "user1",
    "name" : "유저1",
    "nickname" : "유저닉네임1"
  }, {
    "email" : "eastwestspark@xxx.com",
    "id" : "user2",
    "name" : "홍길동",
    "nickname" : "동에번쩍서에번쩍"
  }, {
    "email" : "hnghng@xxx.com",
    "id" : "user3",
    "name" : "흥부",
    "nickname" : "흥이난다흥이나"
  }, {
    "email" : "heavyy@xxx.com",
    "id" : "user4",
    "name" : "두꺼비",
    "nickname" : "heavyy"
  }, {
    "email" : "glashoes@xxx.com",
    "id" : "user5",
    "name" : "신데렐라",
    "nickname" : "유리구두"
  } ]
}
```

![firebase_get_json](https://user-images.githubusercontent.com/38933500/79940777-a4553180-849d-11ea-959e-7c21088c6f7c.png)

#### 규칙 수정
데이터 읽기 가능하고 users 의 id가 인덱스로 설정되게 규칙을 수정한다.
```js
{
  "rules": {
    ".read": true,
    ".write": false,
    "users": {
      ".indexOn": "id"
    }
  }
}
```

### 1.2 SpiderGen Project에 추가

CDN(콘텐츠 전송 네트워크)에서 Firebase 자바스크립트 SDK 라이브러리를 로드되게 설정한다.

#### 방법1. Firebase를 사용할 위치에서 원하는 스크립트 파일을 로드한다.

```js
function FirebaseTestApp*onReady()
{
    super.onReady();

    this.setMainContainer(new APage('main'));
    this.mainContainer.open('Source/MainView.lay');

    afc.loadScript('https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js');
    import 'https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js'
};
```

#### 방법2. 프로젝트 빌드 설정팝업에 로드할 스크립트 태그를 명시한다.

[ Project Properties ] - [ Build ] - [ Script Tag & Link Tag ] 에 작성한다.<br/>
\<script defer src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script><br/>
\<script defer src="https://www.gstatic.com/firebasejs/7.14.1/firebase-database.js"></script>

![build_scriptlink](https://user-images.githubusercontent.com/38933500/79940150-d1084980-849b-11ea-8bb7-b978eb55a925.png)

Firebase 서비스를 사용하기 위해 Firebase를 초기화한다.
개인 프로젝트를 생성한 경우에는 firebaseConfig 내용을 개별 정보로 변경하여 사용한다.

```js
function FirebaseTestApp*onReady()
{
	super.onReady();

	this.setMainContainer(new APage('main'));
	this.mainContainer.open('Source/MainView.lay');
    
	// Your web app's Firebase configuration
	var firebaseConfig = {
		"apiKey": "AIzaSyAbwZvQniv4yL4uuh_YQoPIBbNR4HudTnE",
		"authDomain": "asoosoft-spidergen.firebaseapp.com",
		"databaseURL": "https://asoosoft-spidergen.firebaseio.com",
		"projectId": "asoosoft-spidergen",
		"storageBucket": "asoosoft-spidergen.appspot.com",
		"messagingSenderId": "423891248180",
		"appId": "1:423891248180:web:a89df1828f1440bc661661",
		"measurementId": "G-7CC8D911KY"
	};
	// Initialize Firebase
	firebase.initializeApp(firebaseConfig);
};
```


### 1.3 데이터 요청

Firebase database API 사용법에 맞게 데이터를 요청한다.

#### 1.3.1 전체 데이터 조회

users의 데이터 전체목록을 조회한다.

```js
firebase.database().ref('users').once('value', function(snapshot)
{
    console.log(snapshot.val());
});
```

#### 1.3.2 특정 데이터 조회

users의 데이터 목록중 id 가 user1인 데이터를 조회한다.

```js
var ref = firebase.database().ref('users');
ref.orderByChild('id').equalTo('user1').once('value', function(snapshot)
{
	console.log(snapshot.val());
});
```

#### 1.3.3 화면에 데이터 세팅

수신한 데이터를 화면에 세팅한다. 전체 데이터는 allUserGrid 에 세팅하고 첫번째 데이터는 setDataView에 세팅한다.

```js
var thisObj = this;
firebase.database().ref('users').once('value', function(snapshot)
{
    //그리드에 데이터를 셋팅하려면 배열구조여야 한다.
    var data = snapshot.val();
    thisObj.allUserGrid.setData(data);
    thisObj.setDataView.setData(data[0]);
});
```
![firebase_lay](https://user-images.githubusercontent.com/38933500/79943831-ea61c380-84a4-11ea-8862-496b4eb659b8.png)

### 1.4 실행 화면
![firebase_run](https://user-images.githubusercontent.com/38933500/79944231-fb5f0480-84a5-11ea-9880-5d1e91d62edf.png)


## 2. Open API 연동

### 2.1 오픈 API 키 발급

[영화진흥위원회 오픈API 사이트](http://www.kobis.or.kr/kobisopenapi/homepg/main/main.do) 에 접속한다. 회원가입을 하고 키 발급을 한다.

### 2.1 화면 구성하기

조회하는 데이터의 구조가 아래와 같으므로 해당 데이터를 수신할 컴포넌트의 "name" 속성에 세팅할 데이터의 키를 넣어준다.
```js
{
  "boxofficeType": "",
  "showRange": "",
  "dailyBoxOfficeList": ""
}
 ```

각 컴포넌트에 name 속성을 입력한다. 또한 rankLbl 에 해당 데이터가 있으면 "1위 영화 : 영화명" 없으면 "1위 영화 : - " 로 표현하기 위해 fmt 파일 추가하여 마스크를 만들고 적용한다.
<br />참조: [마스크 함수 생성 및 적용]

![openapi_lay](https://user-images.githubusercontent.com/25051256/79931498-1faae900-8486-11ea-9799-83246bd72a3c.png)



### 2.3 AJAX 데이터 조회 및 세팅

API 사용법에 맞게 데이터 요청 조회를 한다.
<br/>apiKey 에 직접 발급받은 키를 targetDt 에는 원하는 조회 날짜를 넣고 조회한다.

```js
var thisObj = this,
    apiKey = '--------------------------------',
    targetDt = '20200101',
    url = 'http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/'
        + 'searchDailyBoxOfficeList.json?key=' + apiKey
        + '&targetDt=' + targetDt;

$.ajax({
    type:'GET',
    url: url,
    success: function(result)
    {
        thisObj.dataView.setData(result);

        //수신한 데이터의 1위 영화를 rankLbl에 세팅한다.
        var rank1 = result.dailyBoxOfficeList[0],
            rankStr;
        if(rank1) rankStr = rank1.movieNm;
        thisObj.rankLbl.setData(rankStr);
    },
    error: function(error)
    {
        console.error(error);
    }
});

```

### 2.3 실행 화면

![openapi_run](https://user-images.githubusercontent.com/25051256/79932391-63065700-8488-11ea-9703-8b8d1027aa09.png)



















<!-- 
스파이더젠 프로젝트를 오픈한 상태에서 Build > Cordova Started Fast를 선택하면 Cordova를 설치 하고 플랫폼을 추가할 수 있는 창이 나타난다.

![Alt text](./CordovaStartedFast.png)

Cordova Started Fast창 내의 Create cordova project를 누르면 해당 프로젝트폴더 내에 Cordova 폴더가 생성된다. 이 폴더의 위치는 변경되어서는 안된다.

![Alt text](./CordovaDlg.png)

## 2. Android에서 실행

Cordova Started Fast 창의 Select Platform에서 android를 선택한 후 Add a platform 버튼을 누르면 현재 프로젝트의 Cordova 내부에 Android 플랫폼이 추가된다.

이 후 스파이더젠에서 바로 실행을 하려면 Build & Run 을 누르면 되지만, 먼저 [**javac(JDK)**](https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html)와 [**gradle**](https://gradle.org/releases/)의 설치 및 환경변수 세팅이 되어있어야 한다. 설치 후에는 스파이더젠을 재실행 해야한다.

이 과정은 굳이 거치지 않고 [**Android Studio**](https://developer.android.com/studio)를 통해서도 실행이 가능하다.

아래는 안드로이드 기기에서 실행하여 미리 만들어둔 버튼을 클릭하여 알림창을 띄운 화면이다.

<img src ="./StartAndroid.jpg" width="50%" height="50%"></img>

## 3. iOS에서 실행

## 4. 플러그인

프로젝트를 진행하다보면 스파이더젠으로 만들어진 HTML만으로는 불가능한 네이티브의 기능이 필요할 때가 있다. 기기의 진동이나 벨소리 울리기, 앱 이름, 버전, 기기의 모델명 등은 네이티브에서만 실행이 가능하다.

스파이더젠 프로젝트와 네이티브 프로젝트를 이어주는 브릿지 역할을 하는게 플러그인이다. 스파이더젠에서 cordova의 함수를 통해 네이티브로 요청을 하면 네이티브에서 받은 요청에 따라 수행하고 다시 스파이더젠 프로젝트 쪽으로 리턴값을 전달한다.

네이티브에서 어떤 작업을 수행할것인지에 따라 직접 플러그인을 생성할 수 있다.

### 4.1 Android

#### 4.1.2 사용법

먼저, 스파이더젠 프로젝트에서 버튼을 클릭하는 이벤트함수에 아래와 같이 작성한다.

```javascript
function MainView*onAButton1Click(comp, info, e)
{
	cordova.exec( function(result)
	{
		alert(result);
	}, null, "SpidergenPlugin", "sampleMethod", ["PluginTest"]);
};
```

cordova.exec 함수가 cordova를 통해 네이티브로 기능을 요청하는 함수이다.

cordov.exec의 각 파라미터는 다음과 같다.

```javascript
cordova.exec(<성공 시 함수>, <실패 시 함수>, <플러그인 이름>, <행동 이름>, [<인수>]);
```

그 후 Android Studio를 실행해야한다.

Android Studio에서 [File > Open]을 선택하여 스파이더젠 프로젝트에서 생성한 cordova폴더의 안드로이드 프로젝트를 오픈한다. 경로는 다음과 같다.

```
[스파이더젠 프로젝트 경로]\cordova\NewProject\platforms\android
```

그 후 오픈된 안드로이드 프로젝트가 오픈되면 SpidergenPlugin 파일을 오픈한다.

![Alt text](./PluginPath.png)

아래와 같이 기본플러그인으로 screenOrientation과 sampleMethod가 작성되어있는 코드가 보인다.

```java
    @Override
    public boolean execute(String action, JSONArray args, CallbackContext callbackContext) throws JSONException {
        if (action.equals("screenOrientation")) {
            return routeScreenOrientation(args, callbackContext);
        }
        else if (action.equals("sampleMethod")) {
            String message = args.getString(0);
            this.sampleMethod(message, callbackContext);
            return true;
        }
        return false;
    }
```

screenOrientation은 화면의 방향을 정하는 플러그인이고 sampleMethod는 말그대로 샘플 플러그인이다.

스파이더젠에서 sampleMethod을 요청했으므로 action이 sampleMethod인 곳 내부가  실행된다.

내부에서는 args로 부터 message를 받아오고 sampleMethod함수를 실행한다. args에는 스파이더젠에서 배열로 보냈던 인수가 차례대로 저장되어있어 get() 함수를 사용하여 원하는 위치의 인수를 얻어올 수 있다.

sampleMethod함수를 확인해보자.

```java
private void sampleMethod(String message, CallbackContext callbackContext) {
    if (message != null && message.length() > 0) {
        callbackContext.success(message);
    } else {
        callbackContext.error("Expected one non-empty string argument.");
    }
}
```

실행되는 함수 내부를 보면 단순하게 콜백 함수를 실행해주는 내용을 확인할 수 있다.

```java
callbackContext.success(message);

callbackContext.error("Expected one non-empty string argument.");
```

이 함수를 사용하여 받은 message를 다시 스파이더젠으로 리턴해주었다.

처음에 스파이더젠프로젝트에서 작성했던 콜백함수가 호출되어 alert으로 message가 뜨게 될것이다.

플러그인을 추가하기 원한다면 sampleMethod 아래에 새로운 else if 문을 사용하여 원하는 이름을 만들고 스파이더젠에서 cordova.exec를 통해 새로 만든 이름으로 호출해주면 된다.

#### 4.1.4 참고자료

* [**Plugin Development Guide**](https://cordova.apache.org/docs/en/latest/guide/hybrid/plugins/#the-javascript-interface)

* [**Android Plugin Development Guide**](https://cordova.apache.org/docs/en/latest/guide/platforms/android/plugin.html)

### 4.2 iOS

#### 4.2.1 사용법

#### 4.2.2 생성하기 -->